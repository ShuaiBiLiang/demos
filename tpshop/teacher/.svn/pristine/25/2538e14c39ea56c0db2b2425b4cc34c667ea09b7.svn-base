<?php
  namespace Admin\Controller;
  use Think\Controller;
  class GoodsController extends Controller{
    // 商品列表
    public function index(){
      $Goods = D('Goods');

      // 获取所有的商品总数
      $count = $Goods->count();
      
      // 实例化分页类[分页数据的总数,每一页显示的数据量]
      $Page = new \Think\Page($count,3);
      
      $this->style = $Page->show(); // 分页样式的代码

      // 获取分页的数据
      $this->list = $Goods->field('goods_id,goods_name,goods_price,goods_number,goods_small_logo,sale_time,is_show')->limit($Page->firstRow.','.$Page->listRows)->select();   

      $this->display('showList');
    }

    // 添加商品
    public function add(){      
      // 判读是否post提交的数据 
      if( IS_POST ){
        // 判断是否有文件上传
        if( !$_FILES['goods_big_logo']['error'] ){
          // 配置并实例化文件上传操作类
          $config = array(
              'maxSize' => 8388608,               // 上传文件的最大值
              'rootPath' => './Public/Uploads/',  // 上传文件的保存根目录[不会自动创建]
              'savePath' => '/Goods/', //  上传文件的保存路径[会自动创建，并组装路径返回到结果]
              'exts' => array('jpg', 'gif', 'png', 'jpeg'), 
          );
          $Upload = new \Think\Upload($config);
    
          // 进行上传文件处理
          $info = $Upload->upload();

          // 判断图片上传处理成功以后
          if( $info ){
             $_POST['goods_big_logo'] = $info['goods_big_logo']['savepath'] . $info['goods_big_logo']['savename'];

             // 生成缩略图
             $Image = new \Think\Image();
             // 打开源图
             $Image->open( $config['rootPath'] . $_POST['goods_big_logo'] );
             // 指定缩略图的保存路径
             $_POST['goods_small_logo'] =  $info['goods_big_logo']['savepath'] . 'm_' . $info['goods_big_logo']['savename'];

             // 生成缩略图并指定保存的未知
             $Image->thumb(220,220,2)->save( $config['rootPath'] . $_POST['goods_small_logo']); // 缩放填充
          
          }else{
            $this->error( $Upload->getError(),'',5 );die;
          }

        }

        $Goods = D('Goods');
        // 接收$_POST数据并帮我们验证
        if( !$Goods->create() ){
          $this->error( $Goods->getError() );
        }
    
        // 添加数据到Goods表中
        $res = $Goods->add();
        if( $res ){
          $this->success('添加商品成功！',U('index'),3 );
          die();
        }else{
          $this->error('添加商品失败！错误：'. $Goods->getError(), '', 3 );
        }

      }
      $this->display();
    }

    // 商品相册
    public function photos(){
      $this->display();
    }
  }